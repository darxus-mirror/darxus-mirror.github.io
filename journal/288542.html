<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
   <meta http-equiv="X-UA-Compatible" content="IE=7"/>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel='stylesheet' href='http://l-stat.livejournal.com/ad_base.css?v=1256233931' type='text/css' />
<link rel="meta" type="application/rdf+xml" title="FOAF" href="http://darxus.livejournal.com/data/foaf" />
<meta name="foaf:maker" content="foaf:mbox_sha1sum '107c1745aac3c319c0e1588eb400be77055f48e8'" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script>
// don't crawl this.  read http://www.livejournal.com/developer/exporting.bml
var LJ_cmtinfo = {"form_auth":"c0%3A1291194000%3A2585%3A86400%3At2D9G9uvtA-0-YSZLpZVL5MIwSrF%3Ae8edc9da470c75f0d4ce79797d2c24d6","remote":null,"canAdmin":0,"journal":"darxus"}
</script>
        <script type="text/javascript">
            Site = window.Site || {};

            (function(){
                var p = {"media_embed_enabled":1,"inbox_update_poll":0,"has_remote":0,"statprefix":"http://l-stat.livejournal.com","server_time":1291196585,"ctx_popup":1,"remote_is_suspended":0,"imgprefix":"http://l-stat.livejournal.com/img","esn_async":1,"remote_can_track_threads":null,"currentJournal":"darxus","siteroot":"http://www.livejournal.com","currentJournalBase":"http://darxus.livejournal.com"}, i;
                for (i in p) Site[i] = p[i];
            })();
       </script>
    <link rel="stylesheet" type="text/css" href="http://l-stat.livejournal.com/??lj_base.css,esn.css,contextualhover.css?v=1291149814" />
<!--[if IE]><link rel="stylesheet" type="text/css" href="http://l-stat.livejournal.com/??ie.css?v=1291149814" /><![endif]-->
<!--[if lte IE 7]><link rel="stylesheet" type="text/css" href="http://l-stat.livejournal.com/??interstitial_banner_us.css?v=1263499801" /><![endif]-->
<script type="text/javascript" src="http://l-stat.livejournal.com/js/??jquery.js,jquery_fn.js,basic.js,livejournal.js,esn.js,ippu.js,lj_ippu.js,ljwidget.js,ljwidget_ippu.js,journal.js,hourglass.js,contextualhover.js,livejournal-local.js,thread_expander.js,thread_expander.ex.js,quickreply.js,md5.js?v=1289552505"></script>
<script type="text/javascript" src="http://l-stat.livejournal.com/js/??fb-select-image.js,commentmanage.js?v=1291149813"></script>
<script type="text/javascript" src="http://w.sharethis.com/button/sharethis.js#publisher=1483b796-4406-4000-98db-019c32f6059e&amp;type=website&amp;embeds=true&amp;post_services=livejournal%2Cfacebook%2Ctwitter%2Cmyspace%2Cdigg%2Cdelicious%2Clinkedin%2Cfriendfeed%2Cwordpress%2Cblogger%2Cgoogle_bmarks%2Ctechnorati&amp;onmouseover=false"></script><link rel="stylesheet" href="http://darxus.livejournal.com/res/18152266/stylesheet?1291150704" type="text/css" />
<title>Darxus - [geek] rsync nightmare - overwriting the wrong directory</title>

</head>

<body class="page_entry">

<div id="shadowhack1">
<div id="shadowhack2">

<div id="pagecontainer">

<div id="title">
<h1>Darxus</h1><div id="journal_subtitle">[geek] rsync nightmare - overwriting the wrong directory</div>
</div>

<div id="paraphernalia">
<div class="pbox" id="journalinfo"><h2>Darxus</h2><div class="pboxcontent">
<div id="journalinfouserpic"><img src="http://l-userpic.livejournal.com/93571119/874250" title="" alt="2009-09-29"height="100" width="100"  /></div>
<div class="journallinkbar">     <a href="http://www.livejournal.com/todo/?user=darxus"><img border='0' width="24" height="24" alt="darxus&#39;s to-do list" title="darxus&#39;s to-do list" src="http://l-stat.livejournal.com/img/btn_todo.gif"  /></a>  <a href="http://www.livejournal.com/tools/memories.bml?user=darxus"><img border='0' width="24" height="24" alt="darxus&#39;s memories" title="darxus&#39;s memories" src="http://l-stat.livejournal.com/img/btn_memories.gif"  /></a>  <a href="http://www.livejournal.com/tools/tellafriend.bml?user=darxus"><img border='0' width="24" height="24" alt="Tell a friend about darxus" title="Tell a friend about darxus" src="http://l-stat.livejournal.com/img/btn_tellfriend.gif"  /></a>  <a href="http://www.livejournal.com/tools/search.bml?user=darxus"><img border='0' width="24" height="24" alt="Search darxus" title="Search darxus" src="http://l-stat.livejournal.com/img/btn_search.gif"  /></a>  <a href="http://www.livejournal.com/friends/nudge.bml?user=darxus"><img border='0' width="24" height="24" alt="Nudge darxus" title="Nudge darxus" src="http://l-stat.livejournal.com/img/btn_nudge.gif"  /></a> </div></div></div>
<div class="pbox" id="viewsel"><h2>View</h2><div class="pboxcontent">
<ul>
<li><a href="http://darxus.livejournal.com/">Recent Entries</a></li>
<li><a href="http://darxus.livejournal.com/calendar">Archive</a></li>
<li><a href="http://darxus.livejournal.com/friends">Friends</a></li>
<li><a href="http://darxus.livejournal.com/profile">User Info</a></li>
</ul>
</div></div>

</div>

<div id="main">
<div class="entry"><div class="entryheader">
<h3 class="entrysubject">[geek] rsync nightmare - overwriting the wrong directory</h3><div class="entryposter"><span class='ljuser ljuser-name_' lj:user='darxus' style='white-space:nowrap'><a href='http://darxus.livejournal.com/profile'><img src='http://l-stat.livejournal.com/img/userinfo.gif?v=1' alt='[info]' width='17' height='17' style='vertical-align: bottom; border: 0; padding-right: 1px;'/></a><a href='http://darxus.livejournal.com/'><b>darxus</b></a></span></div><div class="entrytimestamp"><span class="entrytimestampdate">11/30/10</span>
    <span class="entrytimestamptime">04:32 pm</span></div><div class="entrylinkbarpre"><a href="http://www.livejournal.com/go.bml?journal=darxus&amp;itemid=288542&amp;dir=prev"><img border='0' width="24" height="24" alt="Previous Entry" title="Previous Entry" src="http://l-stat.livejournal.com/img/btn_prev.gif"  /></a>      <a href="http://www.livejournal.com/tools/memadd.bml?journal=darxus&amp;itemid=288542"><img border='0' width="24" height="24" alt="Add to Memories" title="Add to Memories" src="http://l-stat.livejournal.com/img/btn_memories.gif"  /></a>  <a href="288542.html#"><img border='0' width="24" height="24" alt="Share this!" title="Share this!" src="http://l-stat.livejournal.com/img/btn_sharethis.gif"  /></a> <script type="text/javascript">
            var stLink = jQuery('a:last')[0];
            stLink.href = 'javascript:void(0)';
            SHARETHIS_post = SHARETHIS.addEntry({url:'http://darxus.livejournal.com/288542.html', title: '[geek] rsync nightmare - overwriting the wrong directory'}, {button: false});
            SHARETHIS_post.attachButton(stLink);
            SHARETHIS_ary.push(SHARETHIS_post);
            </script>       <a href="http://www.livejournal.com/go.bml?journal=darxus&amp;itemid=288542&amp;dir=next"><img border='0' width="24" height="24" alt="Next Entry" title="Next Entry" src="http://l-stat.livejournal.com/img/btn_next.gif"  /></a></div>
<div class="entryuserpic"><img src="http://l-userpic.livejournal.com/93571119/874250" title="" alt="2009-09-29"height="100" width="100"  /></div></div>

<div class="entrycontent">I had some data loss that caused me to seriously question my sanity.  <br /><br /><a name="cutid1"></a>I had a 500gb primary hard drive (/), and a 2tb drive (/media/2tb) containing backups of my primary drive and my server, plus about 1.5tb of non-backed-up data.<br /><br />I was attempting some work on an X video driver (nouveau, the open source nVidia driver, porting a patch related to <a href="http://wayland.freedesktop.org">wayland</a>).  There were a few times I got the machine to hang pretty good.  <br /><br />I didn't remember the <a href="http://en.wikipedia.org/wiki/Magic_SysRq_key#.22Raising_Elephants.22_mnemonic_device">magic-sysrq</a> sequence (it's alt-sysrq reisub), and ctrl-alt-del wasn't working.  Or quite possibly was on a 60 second delay I was unaware of.<br /><br />And I wasn't noticing any response to pressing the power button briefly (which should initiate a soft shutdown).  That was probably on the same 60 second delay.  Thanks gnome.<br /><br />So I shut down by holding the power button in for 4 seconds.  A bunch of times.<br /><br />This resulted in my 500gb drive refusing to do anything useful.  I could mount it, fdisk showed me the partition table, but I couldn't read any data, and fsck gave me an interesting error about not being able to read anything.  (<a href="../500gb.2010-11-27.dmesg.html">dmesg</a>)<br /><br />I shut the machine down overnight, hoping that it would be more cooperative in the morning.<br /><br />It wasn't.  But I was able to re-format without problems, and successfully restored a backup from the previous day.  All good.<br /><br />This is where it gets weird.<br /><br />Around that time I noticed the directory containing the ~1.5tb of not backed-up data disappeared.  I tried a program that was supposed to be able to undelete files, and got nothing.  I figured it was another drive crash or something.  There also seemed to be extra files in /media/2tb/, the same as in /.  I ignored that, fearing for my sanity.<br /><br />The next day I checked my backups, and everything in /media/2tb/ was gone, replaced with a backup of / (my primary drive).  Except for the things I --exclude'd.  /dev/ hadn't been copied to /media/2tb/dev/, and /media/2tb/tmp/ contained what it previously had, not what /tmp/ contained.  <br /><br />It sure looked like rsync overwrote it.  And my rsync job was indeed using the --del flag, which would delete anything not in the original which it copied (I since removed that).  <br /><br />But the cron job still said to output to /media/2tb/bak/dancer-`date +\%F` (need to escape %'s in cron jobs).  I checked both my (5,000 line) command histories for any evidence I might have kicked off an rsync wrong and not remembered it, and found nothing unusual.<br /><br />Convinced I must have a split personality which did this to me out of malice and then covered its tracks, I posted to the rsync mailing list.  <br /><br />The next day I got an email from the rsync cron job that contained the line:<br /><br />"created directory /media/2tb/bak/da"<br /><br />The command in the cron job was too long and truncated.  rsync had in fact backed up / to /media/2tb/bak/da/.  <br /><br />The truncated path was exactly as much longer than "/media/2tb/" as the length of "--del " which I had removed.<br /><br />So when it wiped /media/2tb/, it truncated right at /media/2tb/.<a name='cutid1-end'></a></div>

<div class="entryfooter">

<ul class="entrymeta">
<li><span class="entrymetacaption">Tags:</span> <div class='ljtags'><a rel='tag' href='http://darxus.livejournal.com/tag/geek'>geek</a></div></li>
</ul>

<div class="entrylinkbarpost"><a href="http://www.livejournal.com/go.bml?journal=darxus&amp;itemid=288542&amp;dir=prev"><img border='0' width="24" height="24" alt="Previous Entry" title="Previous Entry" src="http://l-stat.livejournal.com/img/btn_prev.gif"  /></a>      <a href="http://www.livejournal.com/tools/memadd.bml?journal=darxus&amp;itemid=288542"><img border='0' width="24" height="24" alt="Add to Memories" title="Add to Memories" src="http://l-stat.livejournal.com/img/btn_memories.gif"  /></a>  <a href="288542.html#"><img border='0' width="24" height="24" alt="Share this!" title="Share this!" src="http://l-stat.livejournal.com/img/btn_sharethis.gif"  /></a> <script type="text/javascript">
            var stLink = jQuery('a:last')[0];
            stLink.href = 'javascript:void(0)';
            SHARETHIS_post = SHARETHIS.addEntry({url:'http://darxus.livejournal.com/288542.html', title: '[geek] rsync nightmare - overwriting the wrong directory'}, {button: false});
            SHARETHIS_post.attachButton(stLink);
            SHARETHIS_ary.push(SHARETHIS_post);
            </script>       <a href="http://www.livejournal.com/go.bml?journal=darxus&amp;itemid=288542&amp;dir=next"><img border='0' width="24" height="24" alt="Next Entry" title="Next Entry" src="http://l-stat.livejournal.com/img/btn_next.gif"  /></a></div>
<ul class="entrycmdlinks"><li><a onclick="return QuickReply.reply('topcomment',0,'')" href="http://darxus.livejournal.com/288542.html?mode=reply">Leave a comment</a></li></ul>
<div  id="ljqrttopcomment" style="display: none;"></div>

</div>
</div>
</div>



<div id="server_sig">Powered by <a href="http://www.livejournal.com/">LiveJournal.com</a></div></div>

</div>
</div>

<div id='hello-world' style='text-align: left; font-size:0; line-height:0; height:0; overflow:hidden;'>
<script type="text/javascript"> var DR_id = 1111; </script>
<script src="http://l-stat.livejournal.com/js/pagestats/DR_v4u3.js?v=1" type="text/javascript"></script>
    <!-- Begin comScore Tag -->
<script>
    document.write(unescape("%3Cscript src='" + (document.location.protocol == "https:" ? "https://sb" : "http://b") + ".scorecardresearch.com/beacon.js' %3E%3C/script%3E"));
</script>

<script>
  COMSCORE.beacon({
    c1:2,
    c2:7602110,
    c3:"",
    c4:"",
    c5:"",
    c6:"",
    c15:""
  });
</script>
<noscript>
  <img src="http://b.scorecardresearch.com/p?c1=2&c2=7602110&c3=&c4=&c5=&c6=&c15=&cj=1" />
</noscript>
<!-- End comScore Tag -->
</div></body>
</html>